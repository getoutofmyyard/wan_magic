Houston-HQ#show run
Building configuration...

Current configuration : 4470 bytes
!
! Last configuration change at 15:56:31 UTC Mon Aug 20 2018
!
version 15.2
service timestamps debug datetime msec
service timestamps log datetime msec
!
hostname Houston-HQ
!
boot-start-marker
boot-end-marker
!
!
!
no aaa new-model
no ip icmp rate-limit unreachable
ip cef
!
!
!
ip dhcp excluded-address 192.168.0.1
ip dhcp excluded-address 192.168.1.1
!
ip dhcp pool HOUSTON                                                                 #Router is configured to serve DHCP requests
 network 192.168.0.0 255.255.255.0                                                   #for both of its VLANs.
 default-router 192.168.0.1
 domain-name houston.local
!
ip dhcp pool HOUSTON2
 network 192.168.1.0 255.255.255.0
 default-router 192.168.1.1
 domain-name houston.local
!
!
no ip domain lookup
no ipv6 cef
!
!
multilink bundle-name authenticated
!
!
ip tcp synwait-time 5
!
!
crypto isakmp policy 1                                                               #Creates IKE/ISAKMP Phase 1 policy and defines IKE
 hash md5                                                                            #phase 1 information 
 authentication pre-share       
 group 2
 !
 !                                                                                   
crypto isakmp key password address 90.85.1.1                                         #These specify PSKs and peer addresses for IKE phase 1.
crypto isakmp key password address 99.100.25.3     255.255.255.240 no-xauth          #I specified the subnet mask and "no-xauth" parameters
crypto isakmp key password address 99.100.25.2     255.255.255.240 no-xauth          #because of the OSPF point-to-multipoint topology for the  
crypto isakmp key password address 99.100.25.4     255.255.255.240 no-xauth          #"Oklahoma" frame relay WAN.      
!                                                                                    
!                                                                                    
!
crypto ipsec transform-set transformset esp-des esp-md5-hmac                  #Creates a transform set named "transformset".
 mode tunnel                                                                  #I used DES and MD5 across all IPSec connections
!                                                                             # to reduce CPU overhead on my PC.
!
!
crypto map map 1 ipsec-isakmp                                                 #A crypto map ("map") is created with four values. 
 set peer 90.85.1.1                                                           #Specifies IPSec peer address,transform set, and an ACL
 set transform-set transformset                                               #to match outgoing LAN-to-LAN IPsec traffic            
 match address ipsec
 !
crypto map map 2 ipsec-isakmp                                                 #I chose to use different ACLs for each IPSec connection 
 set peer 99.100.25.2                                                         #for easier troubleshooting, i.e. ipsec, 107, 108, 109 are 
 set transform-set transformset                                               #all extended access lists.
 match address 107
!
 crypto map map 3 ipsec-isakmp
 set peer 99.100.25.3
 set transform-set transformset
 match address 108
!
crypto map map 4 ipsec-isakmp
 set peer 99.100.25.4
 set transform-set transformset
 match address 109
!
!
!
interface FastEthernet0/0
 ip address 192.168.0.1 255.255.255.0
 ip nat inside
 speed auto
 duplex auto
!
interface FastEthernet0/0.1                                                   #Subinterface on FastEthernet0/0 which is configured
 encapsulation dot1Q 2                                                        #for 802.1Q trunking. Trunk is connected to a L2 switch  
 ip address 192.168.1.1 255.255.255.0                                         #downstream. This is a basic router-on-a-stick configuration 
 ip helper-address 192.168.0.1                                                #for inter-VLAN routing.
 ip nat inside
!
!
interface GigabitEthernet1/0                                                  #WAN interface. Crypto (IPSec) map "map" is applied.
 ip address 70.164.65.65 255.255.255.252                                      #NAT will use this interface's IP address during translation.
 ip nat outside                                                               #EIGRP hold timers modified to reduce CPU overhead
 ip hello-interval eigrp 100 30
 ip hold-time eigrp 100 60
 negotiation auto
 crypto map map
!
!
!
router eigrp 100                                                               #EIGRP ASN 100 configuration with auto-summary disabled
 network 70.164.65.64 0.0.0.3
 network 192.168.0.0
 network 192.168.1.0
!
ip nat inside source route-map nonat interface GigabitEthernet1/0 overload     #NAT configuration. Specifies route map "nonat" for IP matching.
ip forward-protocol nd                                                         #"Overload" means that PAT is being used (all private traffic is
!                                                                              #mapped to the IP of GigabitEthernet1/0 with a corresponding TCP
!									       #port for return delivery
!
!
!
ip route 0.0.0.0 0.0.0.0 GigabitEthernet1/0 70.164.65.66                       #Default route to ISP with next hop (gateway) specified
!
ip access-list extended ipsec
 permit ip 192.168.0.0 0.0.0.255 172.16.1.0 0.0.0.255
 permit ip 192.168.1.0 0.0.0.255 172.16.1.0 0.0.0.255
!
access-list 107 permit ip 192.168.0.0 0.0.0.255 172.20.0.0 0.0.0.255
access-list 107 permit ip 192.168.1.0 0.0.0.255 172.20.0.0 0.0.0.255           #ACLs ipsec, 107, 108, and 109 match IPSec traffic to encrypt.
!                                                                              #All of these should have been configured like 109 for brevity,
!                                                                              #but changing them at this point would require changing the ACLs 
access-list 108 permit ip 192.168.1.0 0.0.0.255 172.20.1.0 0.0.0.255           #on the peers too. I'm too lazy to do that on my own time.
access-list 108 permit ip 192.168.0.0 0.0.0.255 172.20.1.0 0.0.0.255
!
!
access-list 109 permit ip 192.168.0.0 0.0.255.255 172.20.2.0 0.0.0.255
!
!
access-list 110 deny   ip 192.168.1.0 0.0.0.255 172.16.1.0 0.0.0.255           #ACL 110 prevents IPSec traffic from being NAT'd while allowing
access-list 110 deny   ip 192.168.0.0 0.0.0.255 172.16.1.0 0.0.0.255           #all other traffic to be NAT'd. Used by route-map "nonat" for
access-list 110 deny   ip 192.168.0.0 0.0.0.255 172.20.0.0 0.0.0.255           #matching.
access-list 110 deny   ip 192.168.1.0 0.0.0.255 172.20.0.0 0.0.0.255
access-list 110 deny   ip 192.168.0.0 0.0.0.255 172.20.1.0 0.0.0.255
access-list 110 deny   ip 192.168.1.0 0.0.0.255 172.20.1.0 0.0.0.255
access-list 110 deny   ip 192.168.0.0 0.0.255.255 172.20.2.0 0.0.0.255
access-list 110 permit ip 192.168.0.0 0.0.0.255 any
access-list 110 permit ip 192.168.1.0 0.0.0.255 any
!
!
route-map nonat permit 10	                                                   #Creates route map "nonat," which reads ACL 110 and "permits" 
match ip address 110                                                               #(matches) the rules specified. The "deny" rules are skipped
!                                                                                  #and the route map only matches non-IPSec traffic.
end
